{% extends "layout.html" %}

{% block content %}
  <form class="search-form" method="get" action="{{ url_for('search') }}">
    <div>
      <label for="title">Title / Keywords</label>
      <input
        type="text"
        name="title"
        id="title"
        value="{{ form_data.title }}"
        placeholder="e.g. American Gods"
      />
    </div>
    <div>
      <label for="author_id">Author</label>
      <select name="author_id" id="author_id">
        <option value="">-- Any --</option>
        {% for auth in authors %}
          {% set selected = "selected" if form_data.author_id == auth[0]|string else "" %}
          <option value="{{ auth[0] }}" {{ selected }}>{{ auth[1] }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="category_id">Genre</label>
      <select name="category_id" id="category_id">
        <option value="">-- Any --</option>
        {% for cat in categories %}
          {% set selected = "selected" if form_data.category_id == cat[0]|string else "" %}
          <option value="{{ cat[0] }}" {{ selected }}>{{ cat[1] }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Hidden inputs to preserve sort state -->
    <input type="hidden" name="sort_by" value="{{ form_data.sort_by }}">
    <input type="hidden" name="sort_dir" value="{{ form_data.sort_dir }}">

    <!-- Centered buttons under the form -->
    <div class="search-actions">
      <button type="submit">Search</button>
      <a href="{{ url_for('search') }}">Clear</a>
    </div>
  </form>

  {% if results %}
    <div class="results-wrapper">
      <table>
        <thead>
          <tr>
            {#  
               Each <th> is now a link that re‐fires the same /search?q=.. 
               but toggles sort_by and sort_dir accordingly.
            #}
            {% set toggle_dir = "asc" if form_data.sort_dir == "desc" else "desc" %}

            <th>
              <a
                href="{{ url_for('search',
                                title=form_data.title,
                                author_id=form_data.author_id,
                                category_id=form_data.category_id,
                                sort_by='title',
                                sort_dir=( 'asc' if form_data.sort_by != 'title' or form_data.sort_dir=='desc' else 'desc' ) ) }}">
                Title
                {% if form_data.sort_by == 'title' %}
                  {{ '↑' if form_data.sort_dir=='asc' else '↓' }}
                {% endif %}
              </a>
            </th>

            <th>
              <a
                href="{{ url_for('search',
                                title=form_data.title,
                                author_id=form_data.author_id,
                                category_id=form_data.category_id,
                                sort_by='description',
                                sort_dir=( 'asc' if form_data.sort_by != 'description' or form_data.sort_dir=='desc' else 'desc' ) ) }}">
                Description
                {% if form_data.sort_by == 'description' %}
                  {{ '↑' if form_data.sort_dir=='asc' else '↓' }}
                {% endif %}
              </a>
            </th>

            <th>
              <a
                href="{{ url_for('search',
                                title=form_data.title,
                                author_id=form_data.author_id,
                                category_id=form_data.category_id,
                                sort_by='publisher',
                                sort_dir=( 'asc' if form_data.sort_by != 'publisher' or form_data.sort_dir=='desc' else 'desc' ) ) }}">
                Publisher
                {% if form_data.sort_by == 'publisher' %}
                  {{ '↑' if form_data.sort_dir=='asc' else '↓' }}
                {% endif %}
              </a>
            </th>

            <th>
              <a
                href="{{ url_for('search',
                                title=form_data.title,
                                author_id=form_data.author_id,
                                category_id=form_data.category_id,
                                sort_by='publish_date',
                                sort_dir=( 'asc' if form_data.sort_by != 'publish_date' or form_data.sort_dir=='desc' else 'desc' ) ) }}">
                Publish Date
                {% if form_data.sort_by == 'publish_date' %}
                  {{ '↑' if form_data.sort_dir=='asc' else '↓' }}
                {% endif %}
              </a>
            </th>

            <th>Authors</th>
            <th>Genre(s)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in results %}
            <tr>
              <td data-label="Title">{{ row["title"] }}</td>
              <td data-label="Description">{{ row["description"] or "" }}</td>
              <td data-label="Publisher">{{ row["publisher"] or "" }}</td>
              <td data-label="Publish Date">{{ row["publish_date"] or "" }}</td>
              <td data-label="Authors">{{ row["Authors"] or "" }}</td>
              <td data-label="Genre(s)">{{ row["Categories"] or "" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% elif form_data.title or form_data.author_id or form_data.category_id %}
    <p class="no-results">No books matched your criteria.</p>
  {% endif %}
{% endblock %}