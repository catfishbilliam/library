{# templates/search.html #}
{% extends "layout.html" %}

{% block content %}
  <form class="search-form" method="get" action="{{ url_for('search') }}">
    <!-- ─── Form Fields: Title / Author / Genre ─── -->
    <div>
      <label for="title">Title / Keywords</label>
      <input
        type="text"
        name="title"
        id="title"
        value="{{ form_data.title }}"
        placeholder="Enter search terms..."
      />
    </div>
    <div>
      <label for="author_id">Author</label>
      <select name="author_id" id="author_id">
        <option value="">-- Any --</option>
        {% for auth in authors %}
          {% set selected = "selected" if form_data.author_id == auth[0]|string else "" %}
          <option value="{{ auth[0] }}" {{ selected }}>{{ auth[1] }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="category_id">Genre</label>
      <select name="category_id" id="category_id">
        <option value="">-- Any --</option>
        {% for cat in categories %}
          {% set selected = "selected" if form_data.category_id == cat[0]|string else "" %}
          <option value="{{ cat[0] }}" {{ selected }}>{{ cat[1] }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- ─── NLP “I’m feeling…” field ─── -->
    <div style="flex: 1 1 100%; display: flex; flex-direction: column;">
      <label for="nlp"><strong>I'm feeling or looking for...</strong></label>
      <input
        type="text"
        name="nlp"
        id="nlp"
        value="{{ form_data.nlp }}"
        placeholder="e.g. ‘something uplifting about space exploration’"
      />
    </div>

    <!-- ─── Buttons: Search / Add / Clear ─── -->
    <div class="button-row">
      <!-- Search Button -->
      <button type="submit" class="btn-search">Search</button>
      <!-- Add New Book -->
      <a
        href="{{ url_for('add') }}"
        class="btn-add"
        style="display: inline-flex; align-items: center; gap: 6px;"
      >
        <span style="font-size: 1.2rem; line-height: 1;">➕</span>
        <span>Add New Book</span>
      </a>
      <!-- Clear Button -->
      <a href="{{ url_for('search') }}" class="btn-clear">Clear</a>
    </div>

    <!-- ─── Hidden inputs (preserve sort state) ─── -->
    <input type="hidden" name="sort_by"  value="{{ form_data.sort_by }}">
    <input type="hidden" name="sort_dir" value="{{ form_data.sort_dir }}">
  </form>

  {% if results %}
    <div class="results-wrapper">
      <table>
        <thead>
          <tr>
            {% set toggle_dir = "asc" if form_data.sort_dir == "desc" else "desc" %}
            <th>
              <a
                href="{{ url_for('search',
                                  title=form_data.title,
                                  author_id=form_data.author_id,
                                  category_id=form_data.category_id,
                                  nlp=form_data.nlp,
                                  sort_by='title',
                                  sort_dir=( 'asc' 
                                              if form_data.sort_by != 'title' 
                                                 or form_data.sort_dir == 'desc' 
                                              else 'desc' ) ) }}"
              >
                Title
                {% if form_data.sort_by == 'title' %}
                  {{ '↑' if form_data.sort_dir == 'asc' else '↓' }}
                {% endif %}
              </a>
            </th>

            <th>
              <a
                href="{{ url_for('search',
                                  title=form_data.title,
                                  author_id=form_data.author_id,
                                  category_id=form_data.category_id,
                                  nlp=form_data.nlp,
                                  sort_by='description',
                                  sort_dir=( 'asc' 
                                              if form_data.sort_by != 'description' 
                                                 or form_data.sort_dir == 'desc' 
                                              else 'desc' ) ) }}"
              >
                Description
                {% if form_data.sort_by == 'description' %}
                  {{ '↑' if form_data.sort_dir == 'asc' else '↓' }}
                {% endif %}
              </a>
            </th>

            <th>
              <a
                href="{{ url_for('search',
                                  title=form_data.title,
                                  author_id=form_data.author_id,
                                  category_id=form_data.category_id,
                                  nlp=form_data.nlp,
                                  sort_by='publisher',
                                  sort_dir=( 'asc' 
                                              if form_data.sort_by != 'publisher' 
                                                 or form_data.sort_dir == 'desc' 
                                              else 'desc' ) ) }}"
              >
                Publisher
                {% if form_data.sort_by == 'publisher' %}
                  {{ '↑' if form_data.sort_dir == 'asc' else '↓' }}
                {% endif %}
              </a>
            </th>

            <th>
              <a
                href="{{ url_for('search',
                                  title=form_data.title,
                                  author_id=form_data.author_id,
                                  category_id=form_data.category_id,
                                  nlp=form_data.nlp,
                                  sort_by='publish_date',
                                  sort_dir=( 'asc' 
                                              if form_data.sort_by != 'publish_date' 
                                                 or form_data.sort_dir == 'desc' 
                                              else 'desc' ) ) }}"
              >
                Publish Date
                {% if form_data.sort_by == 'publish_date' %}
                  {{ '↑' if form_data.sort_dir == 'asc' else '↓' }}
                {% endif %}
              </a>
            </th>

            <th>Authors</th>
            <th>Genre(s)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in results %}
            <tr>
              <td data-label="Title">{{ row["title"] }}</td>
              <td data-label="Description">{{ row["description"] or "" }}</td>
              <td data-label="Publisher">{{ row["publisher"] or "" }}</td>
              <td data-label="Publish Date">{{ row["publish_date"] or "" }}</td>
              <td data-label="Authors">{{ row["Authors"] or "" }}</td>
              <td data-label="Genre(s)">{{ row["Categories"] or "" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% elif form_data.title or form_data.author_id or form_data.category_id or form_data.nlp %}
    <p class="no-results">No books matched your criteria.</p>
  {% endif %}
{% endblock %}